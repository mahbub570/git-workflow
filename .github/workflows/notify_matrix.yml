name: Notify Matrix Channel of Test Message

on:
  schedule:
    - cron: '30 13 * * 1'  # Every Wednesday at 14:00 UTC 
  workflow_dispatch:  # Allows manual triggering

env:
  FIRST_RUN_DATE: "2024-10-07"  # Set the first Wednesday you want this to run

jobs:
  weekindex:
    runs-on: ubuntu-latest
    outputs:
      weekindex: ${{ steps.calculate.outputs.weekindex }}
      next_bi_weekly_date: ${{ steps.calculate.outputs.next_bi_weekly_date }}
    steps:
      - name: Calculate week difference and next bi-weekly date
        id: calculate
        run: |
          current_date=$(date +%Y-%m-%d)
          start=$(date -d "${{ env.FIRST_RUN_DATE }}" +%s)
          end=$(date -d "$current_date" +%s)
          weekdiff=$(((end - start) / 60 / 60 / 24 / 7))
          weekindex=$((weekdiff % 2))

          # Calculate next bi-weekly date
          if [ "$weekindex" -eq 0 ]; then
            next_bi_weekly_date=$(date -d "$current_date + 14 days" +%Y-%m-%d)
          else
            next_bi_weekly_date=$(date -d "$current_date + 7 days" +%Y-%m-%d)
          fi

          echo "weekindex=$weekindex" >> "$GITHUB_OUTPUT"
          echo "next_bi_weekly_date=$next_bi_weekly_date" >> "$GITHUB_OUTPUT"

          echo "FIRST_RUN_DATE: ${{ env.FIRST_RUN_DATE }}" >> $GITHUB_STEP_SUMMARY
          echo "current_date: $current_date" >> $GITHUB_STEP_SUMMARY
          echo "weekdiff: $weekdiff" >> $GITHUB_STEP_SUMMARY
          echo "weekindex: $weekindex" >> $GITHUB_STEP_SUMMARY
          echo "next_bi_weekly_date: $next_bi_weekly_date" >> $GITHUB_STEP_SUMMARY
          if [ "$weekindex" -eq 0 ]; then
            echo "üü¢ It's the first week of the bi-weekly cycle. The action is going to run." >> $GITHUB_STEP_SUMMARY
          else
            echo "üî¥ It's the second week of the bi-weekly cycle. The action is going to be skipped." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Add Content to Etherpad Without API
        run: |
            pip install requests
            python - <<EOF
            import requests
            import os
        
            # Fetch environment variables
            next_bi_weekly_date = os.environ.get('NEXT_BI_WEEKLY_DATE')
            next_epoch_time = os.environ.get('NEXT_EPOCH_TIME')
            pad_name = f'asif-{next_bi_weekly_date}'
            
            # Construct the Etherpad import URL
            url = f'https://etherpad.wikimedia.org/p/{pad_name}/import'
            print("pod_name",url)
            # Prepare the content with HTML formatting and dynamic data
            content = f'''<html><body>
            <h1>Scribe Dev Sync {next_bi_weekly_date}</h1>
        
            <p>Pad directory: <a href="https://etherpad.wikimedia.org/p/scribe-dev-sync">https://etherpad.wikimedia.org/p/scribe-dev-sync</a><br>
            ZoneStamp: <a href="https://zonestamp.toolforge.org/">https://zonestamp.toolforge.org/</a></p>
        
            <h2>Participants (please list yourself if you'd like to)</h2>
            <ul>
              <li>Participant</li>
            </ul>
        
            <h2>Topics</h2>
            <ul>
              <li>All: introductions üëã</li>
              <li>All: does anyone want a calendar invite to the dev sync? If so, send them out :)</li>
              <li>Recap done by: NAME</li>
              <li>Go through the project board: <a href="https://github.com/orgs/scribe-org/projects/1">Project Board</a></li>
              <li>Name:</li>
            </ul>
        
            <h2>Tasks (strikethrough ^/‚åò + 5 to mark as complete)</h2>
            <ul>
              <li>Task</li>
            </ul>
        
            <h2>Recap</h2>
        
            <p>Here's the recap for today's/Saturday's dev sync üßë‚Äçüíª‚ôªÔ∏è</p>
        
            <ul>
              <li><a href="https://etherpad.wikimedia.org/p/scribe-dev-sync-{next_bi_weekly_date}">Pad for this week</a></li>
              <li>Note</li>
            </ul>
        
            <p>The next dev sync will be <a href="https://zonestamp.toolforge.org/{next_epoch_time}">Saturday {next_bi_weekly_date} at 15:00 UTC</a>.</p>
        
            <p>Nice outro üòä</p>
            </body></html>'''
        
            # Prepare the file to upload
            files = {
                'file': ('import.html', content.encode('utf-8'), 'text/html'),
            }
        
            # Send the POST request to import the content
            response = requests.post(url, files=files)
        
            # Handle the response
            if response.status_code in [200, 302]:
                print(f"Content imported successfully into pad '{pad_name}'.")
            elif response.status_code == 413:
                print("The file is too large to upload.")
            else:
                print(f"Failed to import content. Status code: {response.status_code}")
                print(response.text)
            EOF
        
      - name: Send message to Matrix channel
        id: matrix-chat-message
        uses: fadenb/matrix-chat-message@v0.0.6
        with:
          homeserver: 'matrix.org'
          token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          channel: ${{ secrets.MATRIX_ROOM_ID }}
          message: |
            Hey all! ü§ñüëã Here's the reminder for [this Saturday's dev sync at 15:00 UTC](https://zonestamp.toolforge.org/${{ env.NEXT_EPOCH_TIME }}) ü§ù‚ôªÔ∏è

            Details for it::
            - Call link: https://call.element.io/room/#/activist-dev-sync?roomId=!UddhHUSXxHAoAnImXb:call.ems.host&password=ASriEQCG4DE6Q1QSB313zig0bhLd62RN
            - This week‚Äôs pad: https://etherpad.wikimedia.org/p/activist-dev-sync-${{ env.NEXT_BI_WEEKLY_DATE }}
            - All pads: https://etherpad.wikimedia.org/p/activist-dev-sync

            Please reply with anything you'd like to discuss üßïüèº‚Äç‚ôÄÔ∏è

            Thanks and have a great day! ‚ù§Ô∏è
